# Alembic Database Migrations

This directory contains database migration scripts managed by Alembic for the Org Archivist application.

## Overview

Alembic is used to manage database schema changes over time. Each migration file represents a version of the database schema.

## Migration Workflow

### Creating a New Migration

1. **Automatic Generation** (recommended):
   ```bash
   cd backend
   alembic revision --autogenerate -m "description_of_changes"
   ```

2. **Manual Creation**:
   ```bash
   cd backend
   alembic revision -m "description_of_changes"
   ```

### Applying Migrations

```bash
# Upgrade to latest version
alembic upgrade head

# Upgrade to specific version
alembic upgrade <revision_id>

# Upgrade by one version
alembic upgrade +1
```

### Downgrading Migrations

```bash
# Downgrade by one version
alembic downgrade -1

# Downgrade to specific version
alembic downgrade <revision_id>

# Downgrade all the way
alembic downgrade base
```

### Viewing Migration History

```bash
# Show current version
alembic current

# Show migration history
alembic history

# Show verbose history
alembic history --verbose
```

## Directory Structure

```
alembic/
├── versions/          # Migration scripts
│   └── 2e0140e533a8_baseline_schema.py  # Baseline migration
├── env.py            # Alembic environment configuration
├── script.py.mako    # Template for new migrations
└── README            # This file
```

## Configuration

- **alembic.ini**: Configuration file for Alembic
- **env.py**: Python script that runs migrations, configured to use app settings
- **app/db/models.py**: SQLAlchemy models that define the database schema

The database connection URL is loaded from environment variables via `app/config.py`.

## Baseline Migration

The `baseline_schema` migration (2e0140e533a8) represents the initial state of the database. This schema already exists in the database (created by `docker/postgres/init/01-init-database.sql`), so this migration is a no-op.

To mark a database as being at the baseline without running the migration:

```bash
alembic stamp 2e0140e533a8
```

## Important Notes

1. **Always review autogenerated migrations** before applying them
2. **Test migrations** on a development database before production
3. **Use meaningful migration names** that describe the changes
4. **Keep migrations small and focused** on a single change when possible
5. **Never edit applied migrations** - create a new migration instead

## Common Issues

### Connection Errors

If you get connection errors when running migrations locally:

```bash
# Make sure PostgreSQL is accessible
# For Docker: use postgres host
# For local: use localhost

# Set the database URL explicitly
export DATABASE_URL="postgresql://user:password@localhost:5432/org_archivist"
alembic upgrade head
```

### Import Errors

If you get import errors:

```bash
# Make sure you're in the backend directory
cd backend

# Ensure the app package is importable
python -c "from app.db.models import Base"
```

## Future Migrations

All future schema changes should be managed through Alembic migrations:

1. Create new tables (e.g., `users`, `writing_styles`, `outputs`)
2. Modify existing tables (e.g., add columns, change types)
3. Create/drop indexes
4. Add/remove constraints
5. Data migrations (update existing data)

Example migration for adding a new table:

```bash
alembic revision --autogenerate -m "add_users_table"
# Review the generated file
alembic upgrade head
```

## Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
