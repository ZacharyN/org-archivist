# Alembic Database Migrations

This directory contains database migration scripts managed by Alembic for the Org Archivist application.

## Overview

Org Archivist uses a **pure Alembic approach** for database schema management. All schema changes are managed through Alembic migrations - there are no SQL init scripts. The application automatically runs migrations on startup in development environments.

## Migration Strategy

### Development Workflow (Automatic Migrations)

By default, migrations run automatically when the application starts:

1. **Create a new migration:**
   ```bash
   cd backend
   alembic revision --autogenerate -m "description_of_changes"
   ```

2. **Review the generated migration** in `backend/alembic/versions/`

3. **Restart the application** - migrations will auto-apply on startup

The auto-migration behavior is controlled by the `DISABLE_AUTO_MIGRATIONS` environment variable (default: `false`).

### Production Workflow (Manual Migrations)

For production deployments, disable auto-migrations and run them manually:

1. **Set environment variable:**
   ```bash
   DISABLE_AUTO_MIGRATIONS=true
   ```

2. **Apply migrations manually before deploying:**
   ```bash
   cd backend
   alembic upgrade head
   ```

3. **Deploy the application** - it will verify migrations are current but won't apply them

### Manual Migration Commands

```bash
# Upgrade to latest version
alembic upgrade head

# Upgrade to specific version
alembic upgrade <revision_id>

# Upgrade by one version
alembic upgrade +1

# Downgrade by one version
alembic downgrade -1

# Downgrade to specific version
alembic downgrade <revision_id>

# Downgrade all the way
alembic downgrade base
```

### Viewing Migration History

```bash
# Show current version
alembic current

# Show migration history
alembic history

# Show verbose history
alembic history --verbose
```

## Directory Structure

```
alembic/
├── versions/          # Migration scripts
│   ├── 2e0140e533a8_baseline_schema.py      # Initial full schema
│   ├── d382069dacef_add_writing_styles.py   # Phase 3: Writing styles
│   └── 212c31d97f11_add_seed_data.py        # System config & prompts
├── env.py            # Alembic environment configuration
├── script.py.mako    # Template for new migrations
└── README.md         # This file
```

## Configuration

- **alembic.ini**: Configuration file for Alembic
- **env.py**: Python script that runs migrations, configured to use app settings
- **app/db/models.py**: SQLAlchemy models that define the database schema
- **app/utils/migrations.py**: Auto-migration runner for development

The database connection URL is loaded from environment variables via `app/config.py`.

## Baseline Migration

The `baseline_schema` migration (2e0140e533a8) creates the complete initial database schema including:
- Core tables (documents, prompt_templates, system_config, etc.)
- Users and authentication tables
- Writing styles tables
- All indexes and constraints

This migration represents the full initial state and replaces the previous SQL init scripts.

## Migration Development Guidelines

### Creating Migrations

**Automatic Generation (Recommended):**
```bash
cd backend
alembic revision --autogenerate -m "add_user_preferences_table"
```

**Manual Creation:**
```bash
cd backend
alembic revision -m "add_custom_data_migration"
```

### Testing Migrations

1. **Always review autogenerated migrations** - Alembic may miss some changes
2. **Test both upgrade and downgrade** paths
3. **Test on a copy of production data** before deploying
4. **Verify data integrity** after migration

### Migration Best Practices

1. **Use meaningful names** that describe the change
2. **Keep migrations focused** - one logical change per migration
3. **Add data migrations** for complex schema changes
4. **Never edit applied migrations** - create a new migration to fix issues
5. **Document complex migrations** with comments in the code
6. **Test with real data** before production deployment

## Common Migration Scenarios

### Adding a New Table

```bash
# 1. Add SQLAlchemy model to app/db/models.py
# 2. Generate migration
alembic revision --autogenerate -m "add_outputs_table"
# 3. Review and adjust the generated migration
# 4. Apply (automatic in dev, manual in production)
```

### Adding a Column

```bash
# 1. Update the model in app/db/models.py
# 2. Generate migration
alembic revision --autogenerate -m "add_output_format_column"
# 3. Review generated migration
# 4. Apply migration
```

### Data Migration

```python
# Create manual migration for data changes
# backend/alembic/versions/xxxxx_migrate_data.py

def upgrade():
    # Use op.execute() for data changes
    op.execute("""
        UPDATE documents
        SET status = 'active'
        WHERE status IS NULL
    """)

def downgrade():
    # Provide rollback logic
    op.execute("""
        UPDATE documents
        SET status = NULL
        WHERE status = 'active'
    """)
```

## Troubleshooting

### Auto-Migrations Not Running

Check the application logs for migration output:
```bash
docker-compose logs backend | grep -i migration
```

Verify the environment variable:
```bash
grep DISABLE_AUTO_MIGRATIONS .env
```

### Manual Migration Failures

If a migration fails, check the current state:
```bash
alembic current
alembic history
```

Rollback the failed migration:
```bash
alembic downgrade -1
```

Fix the migration file and retry:
```bash
alembic upgrade head
```

### Connection Errors

Ensure the database URL is correct:
```bash
# For Docker deployment
DATABASE_URL=postgresql://user:password@postgres:5432/org_archivist

# For local development
DATABASE_URL=postgresql://user:password@localhost:5432/org_archivist
```

Test the connection:
```bash
docker exec -it org-archivist-postgres psql -U user -d org_archivist
```

### Import Errors

Ensure you're in the correct directory:
```bash
cd backend
python -c "from app.db.models import Base"
```

If imports fail, check your PYTHONPATH:
```bash
export PYTHONPATH="${PYTHONPATH}:/path/to/org-archivist/backend"
```

## Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- Project: `/docs/auto-migrations.md` - Auto-migration implementation details
